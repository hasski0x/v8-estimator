<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>V8 Estimator</title>
  <script crossorigin src="https://unpkg.com/react@17/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
  <script crossorigin src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    input { display: block; margin-bottom: 10px; }
    button { padding: 5px 10px; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    function App() {
      const [token, setToken] = useState(localStorage.getItem('token') || '');
      const [username, setUsername] = useState('');
      const [password, setPassword] = useState('');
      const [height, setHeight] = useState('');
      const [width, setWidth] = useState('');
      const [qty, setQty] = useState('');
      const [colour, setColour] = useState('');
      const [sqm, setSqm] = useState(0);
      const [estimate, setEstimate] = useState(null);

      useEffect(() => {
        const h = parseFloat(height);
        const w = parseFloat(width);
        const q = parseFloat(qty);
        if (isNaN(h) || isNaN(w) || isNaN(q)) {
          setSqm(0);
        } else {
          setSqm((h * w * q) / 1000000);
        }
      }, [height, width, qty]);

      const handleLogin = async (e) => {
        e.preventDefault();
        try {
          const res = await fetch('http://localhost:3001/api/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, password })
          });
          const data = await res.json();
          if (res.ok) {
            setToken(data.token);
            localStorage.setItem('token', data.token);
          } else {
            alert(data.error || 'Login failed');
          }
        } catch (err) {
          console.error(err);
        }
      };

      const handleSubmit = async (e) => {
        e.preventDefault();
        try {
          const res = await fetch('http://localhost:3001/api/estimate', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({ height, width, qty, colour })
          });
          const data = await res.json();
          setEstimate(data);
        } catch(err) {
          console.error(err);
        }
      };

      if (!token) {
        return (
          <div>
            <h1>Login</h1>
            <form onSubmit={handleLogin}>
              <input placeholder="Username" value={username} onChange={e => setUsername(e.target.value)} />
              <input type="password" placeholder="Password" value={password} onChange={e => setPassword(e.target.value)} />
              <button type="submit">Login</button>
            </form>
          </div>
        );
      }

      return (
        <div>
          <h1>V8 Estimator</h1>
          <form onSubmit={handleSubmit}>
            <input placeholder="Height (mm)" value={height} onChange={e => setHeight(e.target.value)} />
            <input placeholder="Width (mm)" value={width} onChange={e => setWidth(e.target.value)} />
            <input placeholder="Quantity" value={qty} onChange={e => setQty(e.target.value)} />
            <input placeholder="Frame Colour" value={colour} onChange={e => setColour(e.target.value)} />
            <div>SQM: {sqm.toFixed(2)}</div>
            <div>Estimated Cost: $ {(sqm * 490).toFixed(2)}</div>
            <button type="submit">Submit</button>
          </form>
          {estimate && (
            <div style={{marginTop: '20px'}}>
              <h3>Estimate Summary</h3>
              <p>Total SQM: {estimate.sqm.toFixed(2)}</p>
              <p>Total Price: $ {estimate.sellPrice.toFixed(2)}</p>
            </div>
          )}
        </div>
      );
    }

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
